# Nova 语言开发进度报告

## 项目概述

Nova 是一门编译型静态类型语言，语法接近 PHP，运行于自定义虚拟机（使用 Go 实现）。

---

## ✅ 已完成功能

### 1. 基础设施

| 模块 | 状态 | 说明 |
|------|------|------|
| Lexer (词法分析器) | ✅ 完成 | 支持所有 token 类型、关键字、运算符 |
| Parser (语法分析器) | ✅ 完成 | 完整的 AST 构建 |
| AST (抽象语法树) | ✅ 完成 | 所有节点类型定义 |
| Bytecode (字节码) | ✅ 完成 | 指令集、常量池、Chunk 结构 |
| Compiler (编译器) | ✅ 完成 | AST 到字节码的转换 |
| VM (虚拟机) | ✅ 完成 | 栈式虚拟机执行引擎 |
| Runtime (运行时) | ✅ 完成 | 内置函数、类注册 |

### 2. 类型系统

| 功能 | 状态 | 说明 |
|------|------|------|
| int / i8 / i16 / i32 / i64 | ✅ 完成 | 整数类型 |
| float / f32 / f64 | ✅ 完成 | 浮点类型 |
| bool | ✅ 完成 | 布尔类型 |
| string | ✅ 完成 | 字符串类型 |
| null | ✅ 完成 | 空值 |
| 数组 `Type[]` | ✅ 完成 | 动态数组 |
| Map `map[K]V` | ✅ 完成 | 键值映射 |
| 可空类型 `?Type` | ⚠️ 部分 | 语法支持，运行时检查待完善 |

### 3. 变量与表达式

| 功能 | 状态 | 说明 |
|------|------|------|
| 显式类型声明 `int $x = 10` | ✅ 完成 | |
| 类型推导 `$x := 10` | ✅ 完成 | |
| 算术运算 `+ - * / %` | ✅ 完成 | |
| 比较运算 `== != < > <= >=` | ✅ 完成 | |
| 逻辑运算 `&& \|\| !` | ✅ 完成 | |
| 位运算 `& \| ^ ~ << >>` | ✅ 完成 | |
| 三元运算 `? :` | ✅ 完成 | |
| 字符串拼接 `+` | ✅ 完成 | |
| 字符串插值 `#"..."` | ✅ 完成 | 简单变量插值完整支持 |
| 复合赋值 `+= -= *= /=` | ✅ 完成 | |
| 自增自减 `++ --` | ⚠️ 部分 | 语法支持 |

### 4. 控制流

| 功能 | 状态 | 说明 |
|------|------|------|
| if / else / elseif | ✅ 完成 | |
| while | ✅ 完成 | |
| for | ✅ 完成 | |
| foreach | ✅ 完成 | 数组/Map 遍历完整支持 |
| switch / case | ✅ 完成 | 完整运行时支持 |
| break / continue | ✅ 完成 | |
| return | ✅ 完成 | |

### 5. 函数与闭包

| 功能 | 状态 | 说明 |
|------|------|------|
| 普通闭包 `function(...) {...}` | ✅ 完成 | |
| use 捕获变量 `use ($a, $b)` | ✅ 完成 | |
| 箭头函数 `(...) => expr` | ✅ 完成 | 自动捕获外部变量 |
| 函数调用 | ✅ 完成 | |
| 参数传递 | ✅ 完成 | |
| 返回值 | ✅ 完成 | |
| 多返回值 | ✅ 完成 | 完整运行时支持 |
| 可变参数 `...` | ✅ 完成 | 完整支持 |
| 默认参数值 | ✅ 完成 | 完整支持 |

### 6. 面向对象

| 功能 | 状态 | 说明 |
|------|------|------|
| class 定义 | ✅ 完成 | |
| 属性定义 | ✅ 完成 | public/protected/private |
| 方法定义 | ✅ 完成 | |
| 构造函数 `__construct` | ✅ 完成 | |
| 析构函数 `__destruct` | ❌ 未完成 | |
| 继承 `extends` | ✅ 完成 | |
| $this 访问 | ✅ 完成 | |
| parent:: 调用 | ✅ 完成 | 父类常量/方法访问 |
| self:: 调用 | ✅ 完成 | 当前类常量/方法访问 |
| 类常量 `const` | ⚠️ 部分 | 编译支持，访问待完善 |
| 静态属性/方法 `static` | ✅ 完成 | 完整支持静态访问 |
| 接口 `interface` | ✅ 完成 | implements 验证 |
| 抽象类 `abstract` | ✅ 完成 | 抽象类不能实例化 |
| 方法重载 | ❌ 未完成 | |
| 访问控制检查 | ❌ 未完成 | 语法支持，运行时不检查 |
| 注解 `@Annotation` | ❌ 未完成 | |

### 7. 数组与 Map

| 功能 | 状态 | 说明 |
|------|------|------|
| 数组字面量 `[1, 2, 3]` | ✅ 完成 | |
| 数组访问 `$arr[0]` | ✅ 完成 | |
| 数组赋值 `$arr[0] = x` | ✅ 完成 | |
| 数组长度 `.length` | ✅ 完成 | |
| Map 字面量 | ✅ 完成 | |
| Map 访问/赋值 | ✅ 完成 | |
| `.has()` 检查 | ✅ 完成 | 数组/Map 键存在检查 |
| 定长数组 `Type[100]` | ❌ 未完成 | |

### 8. 错误处理

| 功能 | 状态 | 说明 |
|------|------|------|
| try / catch / finally | ✅ 完成 | try/catch 完整支持 |
| throw | ✅ 完成 | 完整支持 |
| 异常类型 | ❌ 未完成 | |

### 9. 内置函数

| 功能 | 状态 |
|------|------|
| print / echo | ✅ 完成 |
| print_r | ✅ 完成 |
| len | ✅ 完成 |
| typeof | ✅ 完成 |
| is_null / is_int / is_string / is_bool | ✅ 完成 |
| int() / string() / float() / bool() | ✅ 完成 |
| push / pop | ✅ 完成 |
| strlen / substr | ✅ 完成 |
| abs / min / max | ✅ 完成 |

### 10. 包管理

| 功能 | 状态 | 说明 |
|------|------|------|
| namespace 声明 | ⚠️ 部分 | 语法支持 |
| use 导入 | ⚠️ 部分 | 语法支持 |
| project.toml | ❌ 未完成 | |
| 多文件编译 | ❌ 未完成 | |

---

## ❌ 未完成功能

### 高优先级

1. ~~**多返回值**~~ - ✅ 已完成
2. ~~**可变参数 `...`**~~ - ✅ 已完成
3. ~~**默认参数值**~~ - ✅ 已完成
4. ~~**foreach 循环**~~ - ✅ 已完成
5. ~~**switch 语句**~~ - ✅ 已完成
6. ~~**静态成员访问**~~ - ✅ 已完成
7. ~~**异常处理**~~ - ✅ 已完成
8. ~~**`.has()` 方法**~~ - ✅ 已完成

### 中优先级

1. ~~**接口实现检查**~~ - ✅ 已完成
2. ~~**抽象类检查**~~ - ✅ 已完成
3. **访问控制** - public/protected/private 运行时检查
4. **析构函数** - `__destruct` 调用
5. **方法重载** - 同名不同参数的方法
6. **注解系统** - `@Annotation` 支持
7. ~~**字符串插值**~~ - ✅ 已完成

### 低优先级

1. **ENUM 枚举** - 完整实现
2. **定长数组** - `Type[100]`
3. ~~**位运算**~~ - ✅ 已完成
4. ~~**parent:: 调用**~~ - ✅ 已完成
5. **类型别名** - 自定义类型名

---

## 🚧 待开发模块

### 1. 垃圾回收器 (GC)
- 标记-清除算法
- 引用计数（可选）
- 内存池管理

### 2. 标准库
- `nova/io` - 文件 I/O
- `nova/net` - TCP/UDP/HTTP
- `nova/time` - 时间处理
- `nova/regex` - 正则表达式
- `nova/json` - JSON 编解码
- `nova/math` - 数学函数
- `nova/crypto` - 加密

### 3. 包管理系统
- `project.toml` 解析
- 多文件编译
- 依赖解析
- 模块导入

### 4. 调试器
- 断点设置
- 单步执行
- 变量查看
- 调用栈跟踪

### 5. 优化
- 常量折叠
- 死代码消除
- 内联优化
- 尾调用优化

---

## 📋 下一步工作计划

### 阶段 1：核心功能完善 (1-2 周)

1. **多返回值实现**
   - 修改 VM 支持多值返回
   - 修改编译器处理多变量赋值

2. **foreach 循环完善**
   - 实现数组迭代器
   - 实现 Map 迭代器

3. **switch 语句实现**
   - 添加 OpSwitch 字节码
   - 实现 case 匹配逻辑

4. **静态成员访问**
   - 实现 `Class::$prop`
   - 实现 `Class::method()`

### 阶段 2：异常处理 (1 周)

1. **try/catch/finally 完整实现**
2. **throw 语句**
3. **异常类层次结构**
4. **调用栈展开**

### 阶段 3：包管理 (2 周)

1. **project.toml 解析**
2. **多文件编译**
3. **namespace 解析**
4. **use 导入实现**

### 阶段 4：GC 与标准库 (2-3 周)

1. **垃圾回收器实现**
2. **基础标准库**
   - io
   - time
   - math

### 阶段 5：优化与调试 (持续)

1. **性能分析**
2. **编译优化**
3. **调试工具**

---

## 📁 项目结构

```
nova/
├── cmd/nova/          # 命令行入口
├── internal/
│   ├── token/         # Token 定义
│   ├── lexer/         # 词法分析器
│   ├── ast/           # AST 节点
│   ├── parser/        # 语法分析器
│   ├── bytecode/      # 字节码定义
│   ├── compiler/      # 编译器
│   ├── vm/            # 虚拟机
│   └── runtime/       # 运行时
├── examples/          # 示例代码
├── design.md          # 语言设计文档
├── PROGRESS.md        # 本进度报告
└── go.mod
```

---

## 🧪 测试命令

```bash
# 运行代码
nova examples/test.nova

# 查看 token
nova -tokens examples/test.nova

# 查看 AST
nova -ast examples/test.nova

# 查看字节码
nova -bytecode examples/test.nova
```

---

*最后更新: 2026-01-05*
*高优先级功能完成: 2026-01-05*

