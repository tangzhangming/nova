// Sola 标准�?- MySQL 连接�?
namespace sola.database.mysql

use sola.database.ConnectionPool;
use sola.database.PoolConfig;
use sola.database.PoolStats;
use sola.database.DatabaseException;
use sola.net.tcp.TcpClient;
use sola.time.Time;

/**
 * MySQL 连接�?
 * 
 * 管理 MySQL 数据库连接的连接池�?
 * 
 * 使用示例�?
 * ```sola
 * use sola.database.mysql.{MysqlPool, PoolConfig};
 * 
 * $config := new PoolConfig();
 * $config->maxSize = 20;
 * 
 * $pool := new MysqlPool($config, "127.0.0.1", 3306, "root", "root", "solalang");
 * 
 * $conn := $pool->get();
 * try {
 *     $result := $conn->query("SELECT * FROM users");
 *     // 使用连接
 * } finally {
 *     $pool->put($conn);
 * }
 * ```
 */
public class MysqlPool extends ConnectionPool<MysqlConnection> {
    
    /** 数据库主�?*/
    private string $host;
    
    /** 数据库端�?*/
    private int $port;
    
    /** 用户�?*/
    private string $user;
    
    /** 密码 */
    private string $password;
    
    /** 数据库名 */
    private string $database;
    
    /** 字符�?*/
    private string $charset;
    
    /**
     * 构造函�?
     * 
     * @param PoolConfig $config 连接池配�?
     * @param string $host 数据库主�?
     * @param int $port 数据库端�?
     * @param string $user 用户�?
     * @param string $password 密码
     * @param string $database 数据库名
     * @param string $charset 字符集，默认 "utf8mb4"
     */
    public function __construct(
        PoolConfig $config,
        string $host,
        int $port,
        string $user,
        string $password,
        string $database,
        string $charset = "utf8mb4"
    ) {
        parent::__construct($config);
        $this->host = $host;
        $this->port = $port;
        $this->user = $user;
        $this->password = $password;
        $this->database = $database;
        $this->charset = $charset;
    }
    
    /**
     * 创建 MySQL 连接（实现抽象方法）
     * 
     * @return MysqlConnection MySQL 连接对象
     */
    protected function createConnection(): MysqlConnection {
        $tcp := new TcpClient();
        $tcp->setConnectTimeout(10000);
        
        if (!$tcp->connect($this->host, $this->port)) {
            throw new DatabaseException("Failed to connect to MySQL: " + $this->host + ":" + $this->port);
        }
        
        return new MysqlConnection($tcp, $this->user, $this->password, $this->database);
    }
    
    /**
     * 验证连接是否有效（实现抽象方法）
     * 
     * @param MysqlConnection $conn 连接对象
     * @return bool 连接是否有效
     */
    protected function validateConnection(MysqlConnection $conn): bool {
        if ($conn == null || $conn->isClosed()) {
            return false;
        }
        return $conn->ping();
    }
    
    /**
     * 关闭连接（实现抽象方法）
     * 
     * @param MysqlConnection $conn 连接对象
     */
    protected function closeConnection(MysqlConnection $conn) {
        if ($conn != null) {
            $conn->close();
        }
    }
    
    /**
     * 获取连接（显式声明以解决泛型问题）
     * 
     * @return MysqlConnection MySQL 连接对象
     */
    public function get(): MysqlConnection {
        // 由于泛型继承问题，直接访问父类的 protected 成员并重新实现逻辑
        if ($this->closed) {
            throw new DatabaseException("Connection pool is closed");
        }
        
        $startTime := Time::now();
        
        while (true) {
            // 检查超时
            $elapsed := Time::now() - $startTime;
            if ($elapsed > $this->config->acquireTimeout) {
                throw new DatabaseException("Failed to acquire connection: timeout");
            }
            
            // 清理过期连接
            $this->cleanup();
            
            // 尝试从空闲池获取
            if (len($this->idle) > 0) {
                $pooled := $this->idle[0];
                // 移除第一个元素（优化：只有在需要时才创建新数组）
                if (len($this->idle) == 1) {
                    $this->idle = [];
                } else {
                    $newIdle := [];
                    for ($i := 1; $i < len($this->idle); $i++) {
                        push($newIdle, $this->idle[$i]);
                    }
                    $this->idle = $newIdle;
                }
                
                // 验证连接
                if ($this->validateConnection($pooled->connection)) {
                    $pooled->updateLastUsed();
                    $this->active++;
                    $this->stats->active = $this->active;
                    $this->stats->idle = len($this->idle);
                    return $pooled->connection;
                } else {
                    // 连接无效，关闭并创建新连接
                    $this->closeConnection($pooled->connection);
                    $this->total--;
                    $this->stats->closed++;
                }
            }
            
            // 如果未达到最大连接数，创建新连接
            if ($this->total < $this->config->maxSize) {
                $conn := $this->createConnection();
                if ($conn != null) {
                    $this->total++;
                    $this->active++;
                    $this->stats->created++;
                    $this->stats->total = $this->total;
                    $this->stats->active = $this->active;
                    $this->stats->idle = len($this->idle);
                    return $conn;
                }
            }
            
            // 等待一段时间后重试
            $this->waiting++;
            $this->stats->waiting = $this->waiting;
            Time::sleep(10); // 休眠 10 毫秒
            $this->waiting--;
            $this->stats->waiting = $this->waiting;
        }
    }
    
    /**
     * 获取统计信息（显式声明）
     * 
     * @return PoolStats 统计信息
     */
    public function stats(): PoolStats {
        return parent::stats();
    }
}
