# 已知 BUG 列表

本文档记录发现但暂未修复的 BUG。

---

## BUG-001: 类型化数组 push 函数返回 dynamic 类型

**发现日期**: 2026-01-11

**严重程度**: 中

**描述**:
类型化数组使用 `push()` 函数后，返回值是 `dynamic` 类型，无法赋值回类型化数组变量。

**复现代码**:
```sola
int[] $arr = int{};
$arr = push($arr, 1);  // 编译错误: 不能将 dynamic 赋值给 int[] 类型的变量
```

**期望行为**:
`push()` 应该返回与输入数组相同的类型 `int[]`，而不是 `dynamic`。

**当前解决方案**:
使用 SuperArray（动态数组）代替类型化数组：
```sola
$arr := [];
$arr[$i] = $value;  // 可以正常工作
```


---

## JIT 编译器状态报告

**更新日期**: 2026-01-11

### 已完成的基础设施

1. **内存布局重构**：
   - `JITObject`: 固定布局对象，字段通过编译期偏移直接访问
   - `JITMap`: 自实现开放寻址哈希表
   - `JITIterator`: 固定布局迭代器
   - `JITClosure`: 固定布局闭包

2. **函数调用系统**：
   - `FunctionTable`: 函数地址解析和延迟绑定
   - `CallHelperById`: 通过函数 ID 调用 VM 执行
   - 支持直接调用和 PLT 间接调用

3. **x64 代码生成**：
   - 基本算术运算（加、减、乘、除、取模）
   - 比较和条件跳转
   - 循环优化
   - NativeArray 操作

### 当前 JIT 支持状态

| 操作类型 | JIT 状态 | 说明 |
|---------|---------|------|
| 基本运算 | ✅ 完全支持 | +, -, *, /, % 等 |
| 条件跳转 | ✅ 完全支持 | if/else, while |
| 循环 | ✅ 完全支持 | for, while |
| NativeArray | ✅ 完全支持 | 类型化定长数组 |
| Map 操作 | ⚠️ Helper 调用 | 通过 JITMap |
| 迭代器 | ⚠️ Helper 调用 | 通过 JITIterator |
| 对象操作 | ⚠️ Helper 调用 | 通过 JITObject |
| 闭包/Upvalue | ⚠️ Helper 调用 | 通过 JITClosure |
| **函数调用** | ❌ **暂时禁用** | VM 回调机制复杂 |
| SuperArray | ❌ 不支持 | 动态类型，无法 JIT |

### 待解决问题

1. **函数调用的 VM 回调**：
   - 当 JIT 代码需要调用未编译函数时，需要回退到 VM
   - VM 的 `execute()` 执行循环不支持"执行到指定帧深度"
   - 需要重新设计帧管理机制

2. **热点函数检测**：
   - 顶层代码不会被 JIT（预期行为）
   - 只有被重复调用的函数才会被编译

### 性能测试结果 (2026-01-11)

简单计算测试（循环、嵌套循环、条件分支）：

| 语言/模式 | 耗时 | 相对性能 |
|-----------|------|---------|
| Go | 173ms | 1.0x (基准) |
| Java | 136ms | 1.27x |
| PHP 8.2 | 945ms | 0.18x |
| Sola (解释器) | ~2400ms | 0.07x |
| Sola (JIT) | ~2400ms | 0.07x |

**说明**: 当前测试的是顶层代码，不会触发 JIT 编译。
实际 JIT 优化需要在热点函数中才能体现。

### 下一步计划

1. 修复函数调用的 JIT 支持
2. 实现单步执行模式用于 VM 回调
3. 优化热点检测策略
4. 添加更多 JIT 内联优化
